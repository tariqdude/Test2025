---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

const filteredHeadings = headings.filter(h => h.depth <= 3);
---

<nav
  class="toc hidden lg:block sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto"
>
  <h2 class="text-sm font-semibold uppercase tracking-wider text-zinc-500 mb-4">
    On this page
  </h2>
  <ul class="space-y-2 text-sm border-l border-zinc-800">
    {
      filteredHeadings.map(heading => (
        <li class={`toc-item depth-${heading.depth}`}>
          <a
            href={`#${heading.slug}`}
            class="text-zinc-400 hover:text-white transition-colors block pl-4 py-1 border-l-2 border-transparent -ml-[1px] hover:border-indigo-500"
          >
            {heading.text}
          </a>
        </li>
      ))
    }
  </ul>
</nav>

<script>
  const observer = new IntersectionObserver(
    entries => {
      entries.forEach(entry => {
        const id = entry.target.getAttribute('id');
        if (!id) return;

        const link = document.querySelector(`.toc a[href="#${id}"]`);
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc a').forEach(a => {
            a.classList.remove(
              'text-indigo-400',
              'border-indigo-500',
              'font-medium'
            );
            a.classList.add('text-zinc-400', 'border-transparent');
          });
          link?.classList.remove('text-zinc-400', 'border-transparent');
          link?.classList.add(
            'text-indigo-400',
            'border-indigo-500',
            'font-medium'
          );
        }
      });
    },
    { rootMargin: '-100px 0px -66%' }
  );

  document.querySelectorAll('article h2, article h3').forEach(h => {
    observer.observe(h);
  });
</script>
