---
/**
 * Client-side error tracking component
 * Captures and reports JavaScript errors and performance issues
 */
---

<script>
  interface ErrorReport {
    message: string;
    stack?: string;
    url: string;
    line?: number;
    column?: number;
    userAgent: string;
    timestamp: number;
    type: 'error' | 'unhandledrejection' | 'warning';
  }

  const errors: ErrorReport[] = [];
  const MAX_ERRORS = 10;

  function sendErrorReport(error: ErrorReport) {
    // Store in localStorage for debugging
    try {
      const stored = JSON.parse(localStorage.getItem('error-reports') || '[]');
      stored.push(error);
      if (stored.length > MAX_ERRORS) {
        stored.shift();
      }
      localStorage.setItem('error-reports', JSON.stringify(stored));
    } catch (e) {
      console.error('Failed to store error report:', e);
    }

    // Log to console in development
    if (import.meta.env.DEV) {
      console.error('[Error Tracking]', error);
    }

    // Send to analytics endpoint (customize this)
    if (navigator.sendBeacon) {
      navigator.sendBeacon('/api/errors', JSON.stringify(error));
    } else {
      fetch('/api/errors', {
        method: 'POST',
        body: JSON.stringify(error),
        keepalive: true,
      }).catch(console.error);
    }
  }

  // Global error handler
  window.addEventListener('error', event => {
    const error: ErrorReport = {
      message: event.message,
      stack: event.error?.stack,
      url: event.filename || window.location.href,
      line: event.lineno,
      column: event.colno,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      type: 'error',
    };
    sendErrorReport(error);
  });

  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', event => {
    const error: ErrorReport = {
      message: event.reason?.message || String(event.reason),
      stack: event.reason?.stack,
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      type: 'unhandledrejection',
    };
    sendErrorReport(error);
  });

  // Console error override (optional)
  const originalConsoleError = console.error;
  console.error = function (...args) {
    originalConsoleError.apply(console, args);

    const error: ErrorReport = {
      message: args.map(arg => String(arg)).join(' '),
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      type: 'error',
    };
    sendErrorReport(error);
  };

  // Type declaration for custom window property (using module augmentation)
  declare global {
    interface Window {
      customReportError?: (
        message: string,
        details?: { stack?: string }
      ) => void;
    }
  }

  // Expose method to manually report errors
  window.customReportError = (
    message: string,
    details?: { stack?: string }
  ) => {
    const error: ErrorReport = {
      message,
      stack: details?.stack,
      url: window.location.href,
      userAgent: navigator.userAgent,
      timestamp: Date.now(),
      type: 'warning',
    };
    sendErrorReport(error);
  };

  // Monitor fetch failures
  const originalFetch = window.fetch;
  window.fetch = async function (...args) {
    try {
      const response = await originalFetch.apply(this, args);
      if (!response.ok && import.meta.env.DEV) {
        console.warn(
          '[Fetch Error]',
          response.status,
          response.statusText,
          args[0]
        );
      }
      return response;
    } catch (error) {
      const errorReport: ErrorReport = {
        message: `Fetch failed: ${error}`,
        url: typeof args[0] === 'string' ? args[0] : window.location.href,
        userAgent: navigator.userAgent,
        timestamp: Date.now(),
        type: 'error',
      };
      sendErrorReport(errorReport);
      throw error;
    }
  };

  // Report to console on page unload (dev only)
  if (import.meta.env.DEV) {
    window.addEventListener('beforeunload', () => {
      const stored = localStorage.getItem('error-reports');
      if (stored) {
        const reports = JSON.parse(stored);
        if (reports.length > 0) {
          console.log('[Error Tracking] Session errors:', reports);
        }
      }
    });
  }
</script>
