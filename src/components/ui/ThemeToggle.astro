---
/**
 * Theme Toggle Component
 * Switches between light, dark, and system preference themes
 * Persists user choice in localStorage
 */

export interface Props {
  variant?: 'icon' | 'button' | 'dropdown';
  showLabel?: boolean;
}

const { variant = 'icon', showLabel = false } = Astro.props;
---

<div class="theme-toggle-wrapper">
  {
    variant === 'icon' ? (
      <button
        id="theme-toggle"
        class="theme-toggle-btn inline-flex items-center justify-center w-10 h-10 rounded-lg border border-white/15 text-slate-200 hover:border-white/25 hover:text-white transition-all hover:scale-105"
        aria-label="Toggle theme"
        title="Toggle theme"
      >
        <svg
          class="theme-icon sun-icon w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
        <svg
          class="theme-icon moon-icon w-5 h-5 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
        <svg
          class="theme-icon system-icon w-5 h-5 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
      </button>
    ) : variant === 'button' ? (
      <button
        id="theme-toggle"
        class="theme-toggle-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-white/15 text-slate-200 hover:border-white/25 hover:text-white transition-all hover:scale-105"
        aria-label="Toggle theme"
      >
        <svg
          class="theme-icon sun-icon w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          />
        </svg>
        <svg
          class="theme-icon moon-icon w-4 h-4 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          />
        </svg>
        <svg
          class="theme-icon system-icon w-4 h-4 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
        {showLabel && (
          <span class="theme-label text-sm font-medium">Theme</span>
        )}
      </button>
    ) : (
      <div class="relative">
        <button
          id="theme-toggle"
          class="theme-toggle-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-white/15 text-slate-200 hover:border-white/25 hover:text-white transition-all"
          aria-label="Toggle theme"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <svg
            class="theme-icon sun-icon w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
          <svg
            class="theme-icon moon-icon w-4 h-4 hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
          </svg>
          <svg
            class="theme-icon system-icon w-4 h-4 hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            />
          </svg>
          <span class="text-sm">Theme</span>
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        <div
          id="theme-menu"
          class="absolute right-0 mt-2 w-48 rounded-lg border border-white/15 bg-slate-900/95 backdrop-blur-lg shadow-lg hidden z-50"
          role="menu"
        >
          <button
            class="theme-option w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors rounded-t-lg"
            data-theme="light"
            role="menuitem"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              />
            </svg>
            <span>Light Mode</span>
            <svg
              class="w-4 h-4 ml-auto hidden check-icon"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <button
            class="theme-option w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors"
            data-theme="dark"
            role="menuitem"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              />
            </svg>
            <span>Dark Mode</span>
            <svg
              class="w-4 h-4 ml-auto hidden check-icon"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <button
            class="theme-option w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-300 hover:bg-white/5 hover:text-white transition-colors rounded-b-lg"
            data-theme="system"
            role="menuitem"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
            <span>System</span>
            <svg
              class="w-4 h-4 ml-auto hidden check-icon"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>
      </div>
    )
  }
</div>

<script>
  type Theme = 'light' | 'dark' | 'system';

  const STORAGE_KEY = 'theme-preference';

  function getThemePreference(): Theme {
    if (typeof localStorage !== 'undefined') {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored === 'light' || stored === 'dark' || stored === 'system') {
        return stored;
      }
    }
    return 'system';
  }

  function getResolvedTheme(preference: Theme): 'light' | 'dark' {
    if (preference === 'system') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light';
    }
    return preference;
  }

  function setTheme(theme: Theme) {
    localStorage.setItem(STORAGE_KEY, theme);
    const resolved = getResolvedTheme(theme);

    document.documentElement.classList.remove('light', 'dark');
    document.documentElement.classList.add(resolved);

    // Update toggle button icon
    updateThemeIcon(theme);

    // Update checkmarks in dropdown
    updateThemeMenu(theme);
  }

  function updateThemeIcon(theme: Theme) {
    const icons = {
      light: document.querySelector('.sun-icon'),
      dark: document.querySelector('.moon-icon'),
      system: document.querySelector('.system-icon'),
    };

    Object.values(icons).forEach(icon => icon?.classList.add('hidden'));
    icons[theme]?.classList.remove('hidden');
  }

  function updateThemeMenu(theme: Theme) {
    document.querySelectorAll('.theme-option').forEach(option => {
      const check = option.querySelector('.check-icon');
      if (option.getAttribute('data-theme') === theme) {
        check?.classList.remove('hidden');
      } else {
        check?.classList.add('hidden');
      }
    });
  }

  function toggleTheme() {
    const current = getThemePreference();
    const next: Theme =
      current === 'light' ? 'dark' : current === 'dark' ? 'system' : 'light';
    setTheme(next);
  }

  // Initialize theme on page load
  const initialTheme = getThemePreference();
  setTheme(initialTheme);

  // Setup toggle button
  const toggleBtn = document.getElementById('theme-toggle');
  toggleBtn?.addEventListener('click', e => {
    const menu = document.getElementById('theme-menu');
    if (menu) {
      // Dropdown variant
      menu.classList.toggle('hidden');
      toggleBtn.setAttribute(
        'aria-expanded',
        menu.classList.contains('hidden') ? 'false' : 'true'
      );
    } else {
      // Icon/button variant
      toggleTheme();
    }
  });

  // Setup dropdown options
  document.querySelectorAll('.theme-option').forEach(option => {
    option.addEventListener('click', e => {
      const theme = (e.currentTarget as HTMLElement).getAttribute(
        'data-theme'
      ) as Theme;
      setTheme(theme);
      document.getElementById('theme-menu')?.classList.add('hidden');
      toggleBtn?.setAttribute('aria-expanded', 'false');
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', e => {
    const menu = document.getElementById('theme-menu');
    const target = e.target;
    if (
      target instanceof Node &&
      menu &&
      !menu.classList.contains('hidden') &&
      !menu.contains(target) &&
      !toggleBtn?.contains(target)
    ) {
      menu.classList.add('hidden');
      toggleBtn?.setAttribute('aria-expanded', 'false');
    }
  });

  // Listen for system theme changes
  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', () => {
      const current = getThemePreference();
      if (current === 'system') {
        setTheme('system'); // Re-apply to update resolved theme
      }
    });
</script>

<style>
  .theme-toggle-btn {
    transition: all 0.2s ease-in-out;
  }

  .theme-toggle-btn:active {
    transform: scale(0.95);
  }

  .theme-icon {
    transition: opacity 0.2s ease-in-out;
  }

  #theme-menu {
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
