---
/**
 * Modal - Accessible modal dialog component
 * Features backdrop blur, animations, and keyboard navigation
 */
export interface Props {
  id: string;
  title?: string;
  size?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
  closeOnBackdrop?: boolean;
  closeOnEscape?: boolean;
  showClose?: boolean;
  className?: string;
}

const {
  id,
  title,
  size = 'md',
  closeOnBackdrop = true,
  closeOnEscape = true,
  showClose = true,
  className = '',
} = Astro.props;

const sizes = {
  sm: 'max-w-md',
  md: 'max-w-2xl',
  lg: 'max-w-4xl',
  xl: 'max-w-6xl',
  full: 'max-w-full mx-4',
};
---

<div
  id={id}
  class="modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby={title ? `${id}-title` : undefined}
  data-close-backdrop={closeOnBackdrop}
  data-close-escape={closeOnEscape}
>
  <div class="modal-backdrop"></div>
  <div class="modal-container">
    <div class={`modal-content ${sizes[size]} ${className}`}>
      {
        (title || showClose) && (
          <div class="modal-header">
            {title && (
              <h2 id={`${id}-title`} class="modal-title">
                {title}
              </h2>
            )}
            {showClose && (
              <button
                class="modal-close"
                aria-label="Close modal"
                data-modal-close={id}
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
            )}
          </div>
        )
      }
      <div class="modal-body">
        <slot />
      </div>
    </div>
  </div>
</div>

<script>
  class ModalManager {
    private modals: Map<string, HTMLElement> = new Map();
    private focusableElements =
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    private previousFocus: HTMLElement | null = null;

    constructor() {
      this.init();
    }

    init() {
      // Register all modals
      document.querySelectorAll('.modal').forEach((modal) => {
        const id = modal.id;
        if (id) {
          this.modals.set(id, modal as HTMLElement);
          this.setupModal(modal as HTMLElement);
        }
      });

      // Setup triggers
      document.querySelectorAll('[data-modal-open]').forEach((trigger) => {
        trigger.addEventListener('click', (e) => {
          e.preventDefault();
          const modalId = (trigger as HTMLElement).getAttribute(
            'data-modal-open'
          );
          if (modalId) this.open(modalId);
        });
      });

      // Setup close buttons
      document.querySelectorAll('[data-modal-close]').forEach((button) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const modalId = (button as HTMLElement).getAttribute(
            'data-modal-close'
          );
          if (modalId) this.close(modalId);
        });
      });

      // Expose global functions with namespacing
      if (typeof window !== 'undefined') {
        (window as any).ui = (window as any).ui || {};
        (window as any).ui.openModal = this.open.bind(this);
        (window as any).ui.closeModal = this.close.bind(this);
        // Legacy support
        (window as any).openModal = this.open.bind(this);
        (window as any).closeModal = this.close.bind(this);
      }
    }

    setupModal(modal: HTMLElement) {
      const closeOnBackdrop =
        modal.getAttribute('data-close-backdrop') !== 'false';
      const closeOnEscape =
        modal.getAttribute('data-close-escape') !== 'false';

      // Close on backdrop click
      if (closeOnBackdrop) {
        const backdrop = modal.querySelector('.modal-backdrop');
        backdrop?.addEventListener('click', () => this.close(modal.id));
      }

      // Close on escape key
      if (closeOnEscape) {
        document.addEventListener('keydown', (e) => {
          if (
            e.key === 'Escape' &&
            modal.classList.contains('modal-open')
          ) {
            this.close(modal.id);
          }
        });
      }

      // Trap focus
      modal.addEventListener('keydown', (e) => {
        if (e.key === 'Tab' && modal.classList.contains('modal-open')) {
          this.trapFocus(e, modal);
        }
      });
    }

    open(id: string) {
      const modal = this.modals.get(id);
      if (!modal) return;

      // Store current focus
      this.previousFocus = document.activeElement as HTMLElement;

      // Open modal
      modal.classList.add('modal-open');
      document.body.style.overflow = 'hidden';

      // Focus first focusable element
      setTimeout(() => {
        const firstFocusable = modal.querySelector(
          this.focusableElements
        ) as HTMLElement;
        firstFocusable?.focus();
      }, 100);
    }

    close(id: string) {
      const modal = this.modals.get(id);
      if (!modal) return;

      modal.classList.remove('modal-open');
      document.body.style.overflow = '';

      // Restore focus
      if (this.previousFocus) {
        this.previousFocus.focus();
        this.previousFocus = null;
      }
    }

    trapFocus(e: KeyboardEvent, modal: HTMLElement) {
      const focusableContent = modal.querySelectorAll(this.focusableElements);
      const firstFocusable = focusableContent[0] as HTMLElement;
      const lastFocusable = focusableContent[
        focusableContent.length - 1
      ] as HTMLElement;

      if (e.shiftKey && document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      } else if (!e.shiftKey && document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new ModalManager();
  });
</script>

<style>
  .modal {
    position: fixed;
    inset: 0;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .modal-open {
    opacity: 1;
    visibility: visible;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    cursor: pointer;
  }

  .modal-container {
    position: relative;
    z-index: 9999;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 1rem;
  }

  .modal-content {
    position: relative;
    margin: 0 auto;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  :global(.dark) .modal-content {
    background: rgba(24, 24, 27, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modal-open .modal-content {
    transform: scale(1);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .modal-header {
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    color: rgba(15, 23, 42, 1);
  }

  :global(.dark) .modal-title {
    color: rgba(255, 255, 255, 0.95);
  }

  .modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border: none;
    background: transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    color: rgba(0, 0, 0, 0.6);
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: rgba(0, 0, 0, 0.9);
  }

  :global(.dark) .modal-close {
    color: rgba(255, 255, 255, 0.6);
  }

  :global(.dark) .modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
  }

  .modal-close:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  .modal-body {
    padding: 1.5rem;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .modal,
    .modal-content {
      transition: none;
    }
  }
</style>
