---
/**
 * Search Component
 * Client-side search for blog posts and site content using Fuse.js
 * Includes keyboard shortcuts (Cmd+K / Ctrl+K) and instant results
 */

import { withBasePath } from '../../utils/helpers';
import { getCollection } from 'astro:content';

export interface Props {
  placeholder?: string;
  maxResults?: number;
  class?: string;
}

const {
  placeholder = 'Search posts...',
  maxResults = 5,
  class: className = '',
} = Astro.props;

// Get all blog posts for search indexing
const posts = await getCollection('blog');

const searchData = posts.map(post => ({
  title: post.data.title,
  description: post.data.description,
  id: post.id.replace('.md', '').replace('.mdx', ''),
  pubDate: post.data.pubDate,
}));

const blogBasePath = withBasePath('blog/');
const searchId = `search-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  class={`search-wrapper ${className}`}
  data-search-wrapper
  data-search-data={JSON.stringify(searchData)}
  data-max-results={maxResults}
  data-blog-base-path={blogBasePath}
>
  <div class="relative" role="search">
    <label for={searchId} class="sr-only">Search posts</label>
    <input
      aria-label="Search posts"
      type="search"
      id={searchId}
      placeholder={placeholder}
      class="w-full px-4 py-3 pl-12 pr-16 bg-slate-800/50 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
      aria-describedby={`${searchId}-hint`}
      aria-controls={`${searchId}-results`}
      aria-expanded="false"
      autocomplete="off"
      spellcheck="false"
    />
    <svg
      class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <kbd
      class="absolute right-4 top-1/2 -translate-y-1/2 px-2 py-1 text-xs text-slate-400 bg-slate-900 border border-slate-700 rounded pointer-events-none"
      aria-hidden="true"
    >
      <span class="hidden sm:inline">âŒ˜K</span>
      <span class="sm:hidden">Ctrl+K</span>
    </kbd>
    <span id={`${searchId}-hint`} class="sr-only">
      Type at least 2 characters to search. Use arrow keys to navigate results.
    </span>
  </div>

  <!-- Search Results -->
  <div
    id={`${searchId}-results`}
    class="hidden absolute z-50 w-full mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-2xl max-h-96 overflow-y-auto"
    role="listbox"
    aria-label="Search results"
  >
    <div id={`${searchId}-list`} class="py-2"></div>
    <div
      id={`${searchId}-status`}
      class="sr-only"
      aria-live="polite"
      aria-atomic="true"
    >
    </div>
  </div>
</div>

<script>
  import Fuse from 'fuse.js';
  import { debounce } from '../../utils/function';

  function initSearch(wrapper: Element) {
    if (!(wrapper instanceof HTMLElement)) return;

    const searchDataStr = wrapper.dataset.searchData;
    if (!searchDataStr) return;

    const searchData = JSON.parse(searchDataStr);
    const maxResults = parseInt(wrapper.dataset.maxResults || '5', 10);
    const blogBasePath = wrapper.dataset.blogBasePath || '/blog/';

    const input = wrapper.querySelector(
      'input[type="search"]'
    ) as HTMLInputElement;
    if (!input) return;

    const searchId = input.id;
    const results = document.getElementById(`${searchId}-results`);
    const resultsList = document.getElementById(`${searchId}-list`);
    const searchStatus = document.getElementById(`${searchId}-status`);

    if (!results || !resultsList) return;

    const fuse = new Fuse(searchData, {
      keys: [
        { name: 'title', weight: 2 },
        { name: 'description', weight: 1 },
      ],
      threshold: 0.4,
      includeScore: true,
      minMatchCharLength: 2,
    });

    let selectedIndex = -1;

    // Announce results to screen readers
    function announceResults(count: number, query: string) {
      if (searchStatus) {
        if (count === 0) {
          searchStatus.textContent = `No results found for "${query}"`;
        } else {
          searchStatus.textContent = `${count} result${count === 1 ? '' : 's'} found for "${query}"`;
        }
      }
    }

    function performSearch(query: string) {
      if (!query || query.length < 2) {
        results?.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        return;
      }

      const searchResults = fuse.search(query, { limit: maxResults });

      // Clear previous results
      if (resultsList) {
        resultsList.textContent = '';
      }

      if (searchResults.length === 0) {
        if (resultsList) {
          const noResultsDiv = document.createElement('div');
          noResultsDiv.className = 'px-4 py-3 text-slate-400 text-sm';
          noResultsDiv.setAttribute('role', 'status');
          noResultsDiv.textContent = `No results found for "${query}"`;
          resultsList.appendChild(noResultsDiv);
        }
        results?.classList.remove('hidden');
        input.setAttribute('aria-expanded', 'true');
        announceResults(0, query);
        return;
      }

      if (resultsList) {
        searchResults.forEach((result, index) => {
          const link = document.createElement('a');
          link.href = `${blogBasePath}${encodeURIComponent(result.item.id)}`;
          link.className = `block px-4 py-3 hover:bg-slate-700 focus:bg-slate-700 focus:outline-none transition-colors ${index === selectedIndex ? 'bg-slate-700' : ''}`;
          link.dataset.resultIndex = index.toString();
          link.setAttribute('role', 'option');
          link.setAttribute(
            'aria-selected',
            (index === selectedIndex).toString()
          );

          const titleDiv = document.createElement('div');
          titleDiv.className = 'font-semibold text-slate-200';
          titleDiv.textContent = result.item.title;
          link.appendChild(titleDiv);

          const descDiv = document.createElement('div');
          descDiv.className = 'text-sm text-slate-400 mt-1 line-clamp-2';
          descDiv.textContent = result.item.description;
          link.appendChild(descDiv);

          resultsList.appendChild(link);
        });
      }

      results?.classList.remove('hidden');
      input.setAttribute('aria-expanded', 'true');
      selectedIndex = -1;
      announceResults(searchResults.length, query);
    }

    // Input handler with debounce
    const handleInput = debounce((e: Event) => {
      const target = e.target as HTMLInputElement;
      performSearch(target.value);
    }, 200);

    input.addEventListener('input', handleInput);

    // Keyboard navigation
    input.addEventListener('keydown', e => {
      if (!resultsList) return;
      const resultItems = resultsList.querySelectorAll('a');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, resultItems.length - 1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        (resultItems[selectedIndex] as HTMLElement)?.click();
      } else if (e.key === 'Escape') {
        results?.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
        input.blur();
      }
    });

    function updateSelectedResult(items: NodeListOf<Element>) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('bg-slate-700');
          item.setAttribute('aria-selected', 'true');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('bg-slate-700');
          item.setAttribute('aria-selected', 'false');
        }
      });
    }

    // Click outside to close
    document.addEventListener('click', e => {
      if (!wrapper.contains(e.target as Node)) {
        results?.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');
      }
    });

    // Keyboard shortcut (Cmd+K / Ctrl+K)
    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        input.focus();
      }
    });
  }

  // Initialize on load
  document.querySelectorAll('[data-search-wrapper]').forEach(initSearch);

  // Re-initialize on view transitions (if used)
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('[data-search-wrapper]').forEach(initSearch);
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
