---
/**
 * Search Component
 * Client-side search for blog posts and site content using Fuse.js
 * Includes keyboard shortcuts (Cmd+K / Ctrl+K) and instant results
 */

import { withBasePath } from '../../utils/helpers';

export interface Props {
  placeholder?: string;
  maxResults?: number;
  class?: string;
}

const {
  placeholder = 'Search posts...',
  maxResults = 5,
  class: className = '',
} = Astro.props;

// Get all blog posts for search indexing
import { getCollection } from 'astro:content';
const posts = await getCollection('blog');

const searchData = posts.map(post => ({
  title: post.data.title,
  description: post.data.description,
  id: post.id.replace('.md', '').replace('.mdx', ''),
  pubDate: post.data.pubDate,
}));

const blogBasePath = withBasePath('blog/');
---

<div class={`search-wrapper ${className}`} data-search-wrapper>
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder={placeholder}
      class="w-full px-4 py-3 pl-12 pr-4 bg-slate-800/50 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
      aria-label="Search"
    />
    <svg
      class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <kbd
      class="absolute right-4 top-1/2 -translate-y-1/2 px-2 py-1 text-xs text-slate-400 bg-slate-900 border border-slate-700 rounded"
    >
      âŒ˜K
    </kbd>
  </div>

  <!-- Search Results -->
  <div
    id="search-results"
    class="hidden absolute z-50 w-full mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-2xl max-h-96 overflow-y-auto"
  >
    <div id="results-list" class="py-2"></div>
  </div>
</div>

<script define:vars={{ searchData, maxResults, blogBasePath }}>
  // Dynamically import Fuse.js
  let Fuse;

  async function initSearch() {
    if (!Fuse) {
      const module = await import(
        'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.mjs'
      );
      Fuse = module.default;
    }

    const fuse = new Fuse(searchData, {
      keys: [
        { name: 'title', weight: 2 },
        { name: 'description', weight: 1 },
      ],
      threshold: 0.4,
      includeScore: true,
      minMatchCharLength: 2,
    });

    const input = document.getElementById('search-input');
    const results = document.getElementById('search-results');
    const resultsList = document.getElementById('results-list');

    if (!input || !results || !resultsList) return;

    let selectedIndex = -1;

    function performSearch(query) {
      if (!query || query.length < 2) {
        results.classList.add('hidden');
        return;
      }

      const searchResults = fuse.search(query, { limit: maxResults });

      if (searchResults.length === 0) {
        resultsList.innerHTML = `
          <div class="px-4 py-3 text-slate-400 text-sm">
            No results found for "${query}"
          </div>
        `;
        results.classList.remove('hidden');
        return;
      }

      resultsList.innerHTML = searchResults
        .map(
          (result, index) => `
          <a
            href="${blogBasePath}${result.item.id}"
            class="block px-4 py-3 hover:bg-slate-700 transition-colors ${index === selectedIndex ? 'bg-slate-700' : ''}"
            data-result-index="${index}"
          >
            <div class="font-semibold text-slate-200">${result.item.title}</div>
            <div class="text-sm text-slate-400 mt-1 line-clamp-2">${result.item.description}</div>
          </a>
        `
        )
        .join('');

      results.classList.remove('hidden');
      selectedIndex = -1;
    }

    // Input handler with debounce
    let debounceTimer;
    input.addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        performSearch(e.target.value);
      }, 200);
    });

    // Keyboard navigation
    input.addEventListener('keydown', e => {
      const resultItems = resultsList.querySelectorAll('a');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, resultItems.length - 1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelectedResult(resultItems);
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        resultItems[selectedIndex]?.click();
      } else if (e.key === 'Escape') {
        results.classList.add('hidden');
        input.blur();
      }
    });

    function updateSelectedResult(items) {
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('bg-slate-700');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('bg-slate-700');
        }
      });
    }

    // Click outside to close
    document.addEventListener('click', e => {
      if (!e.target.closest('[data-search-wrapper]')) {
        results.classList.add('hidden');
      }
    });

    // Keyboard shortcut (Cmd+K / Ctrl+K)
    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        input.focus();
      }
    });
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
