---
/**
 * Lazy Image Component
 * Implements Intersection Observer for performant lazy loading
 * Supports blur placeholder and responsive images
 */

export interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  blurHash?: string;
  sizes?: string;
  srcset?: string;
}

const {
  src,
  alt,
  width,
  height,
  class: className = '',
  loading = 'lazy',
  blurHash,
  sizes,
  srcset,
} = Astro.props;

const placeholderSvg = blurHash
  ? `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${width || 100} ${height || 100}'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='20'/%3E%3C/filter%3E%3Cimage preserveAspectRatio='none' filter='url(%23b)' x='0' y='0' height='100%25' width='100%25' href='${blurHash}'/%3E%3C/svg%3E`
  : undefined;
---

<div class={`lazy-image-wrapper ${className}`} data-lazy-image>
  {
    loading === 'lazy' ? (
      <>
        <img
          alt={alt}
          class="lazy-image blur-up"
          data-src={src}
          data-srcset={srcset}
          data-sizes={sizes}
          src={
            placeholderSvg ||
            'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1"%3E%3C/svg%3E'
          }
          width={width}
          height={height}
          loading="lazy"
          decoding="async"
        />
        <noscript>
          <img
            alt={alt}
            src={src}
            srcset={srcset}
            sizes={sizes}
            width={width}
            height={height}
            loading="lazy"
          />
        </noscript>
      </>
    ) : (
      <img
        alt={alt}
        src={src}
        srcset={srcset}
        sizes={sizes}
        width={width}
        height={height}
        loading="eager"
        decoding="async"
        class={className}
      />
    )
  }
</div>

<script>
  // Lazy loading with Intersection Observer
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const container = entry.target as HTMLElement;
            const img = container.querySelector(
              'img.lazy-image'
            ) as HTMLImageElement;

            if (img) {
              const src = img.getAttribute('data-src');
              const srcset = img.getAttribute('data-srcset');
              const sizes = img.getAttribute('data-sizes');

              if (src) {
                img.src = src;
                img.removeAttribute('data-src');
              }

              if (srcset) {
                img.srcset = srcset;
                img.removeAttribute('data-srcset');
              }

              if (sizes) {
                img.sizes = sizes;
                img.removeAttribute('data-sizes');
              }

              img.addEventListener('load', () => {
                img.classList.add('loaded');
                img.classList.remove('blur-up');
              });

              observer.unobserve(container);
            }
          }
        });
      },
      {
        rootMargin: '50px 0px',
        threshold: 0.01,
      }
    );

    // Observe all lazy image containers
    document.querySelectorAll('[data-lazy-image]').forEach(container => {
      imageObserver.observe(container);
    });
  } else {
    // Fallback for browsers without IntersectionObserver
    document.querySelectorAll('img.lazy-image').forEach(img => {
      const image = img as HTMLImageElement;
      const src = image.getAttribute('data-src');
      const srcset = image.getAttribute('data-srcset');
      const sizes = image.getAttribute('data-sizes');

      if (src) image.src = src;
      if (srcset) image.srcset = srcset;
      if (sizes) image.sizes = sizes;

      image.classList.add('loaded');
      image.classList.remove('blur-up');
    });
  }
</script>

<style>
  .lazy-image-wrapper {
    position: relative;
    overflow: hidden;
  }

  .lazy-image {
    display: block;
    width: 100%;
    height: auto;
    transition:
      opacity 0.3s ease-in-out,
      filter 0.3s ease-in-out;
  }

  .lazy-image.blur-up {
    filter: blur(20px);
    transform: scale(1.05);
  }

  .lazy-image.loaded {
    filter: blur(0);
    transform: scale(1);
  }

  /* Aspect ratio placeholder to prevent layout shift */
  .lazy-image-wrapper::before {
    content: '';
    display: block;
    padding-bottom: calc(var(--aspect-ratio, 56.25) * 1%);
  }

  .lazy-image-wrapper img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>
