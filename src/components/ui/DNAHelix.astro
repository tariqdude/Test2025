---
/**
 * DNA Helix - 3D rotating double helix structure
 * Enhanced with gene sequencing, color coding, and interactive controls
 */
import ModernButton from './ModernButton.astro';
---

<div class="dna-wrapper">
  <h2 class="dna-title">3D DNA Helix Structure</h2>
  <p class="dna-subtitle">
    Interactive genetic sequencing • Click bases to highlight • Hover to pause
  </p>

  <div class="dna-controls">
    <ModernButton variant="neon" className="dna-btn active" data-speed="normal"
      >Normal Speed</ModernButton
    >
    <ModernButton variant="neon" className="dna-btn" data-speed="fast"
      >Fast Replication</ModernButton
    >
    <ModernButton variant="neon" className="dna-btn" data-speed="slow"
      >Study Mode</ModernButton
    >
    <ModernButton variant="neon" className="dna-btn" data-color="rainbow"
      >Rainbow Mode</ModernButton
    >
  </div>

  <div class="dna-stats">
    <div class="stat-item">
      <span class="stat-label">Base Pairs</span>
      <span class="stat-value">60</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Rotation</span>
      <span class="stat-value" data-rotation>0°</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Selected</span>
      <span class="stat-value" data-selected>None</span>
    </div>
  </div>

  <div class="dna-container" data-dna-interactive>
    <div class="dna-helix" data-dna-rotation>
      {
        Array.from({ length: 60 }).map((_, i) => {
          const angle = (i / 60) * 360 * 2.5;
          const y = i * 15 - 450;
          const baseType = ['A', 'T', 'G', 'C'][i % 4];
          const pairType =
            baseType === 'A'
              ? 'T'
              : baseType === 'T'
                ? 'A'
                : baseType === 'G'
                  ? 'C'
                  : 'G';

          return (
            <div class="base-pair" data-index={i}>
              <div
                class="dna-sphere strand-1"
                data-base={baseType}
                data-clickable
                style={`
                --angle: ${angle}deg;
                --y: ${y}px;
                --delay: ${i * 0.03}s;
                --hue: ${i * 6};
              `}
              >
                <div class="base-label">{baseType}</div>
                <div class="sphere-glow" />
              </div>
              <div
                class="dna-sphere strand-2"
                data-base={pairType}
                data-clickable
                style={`
                --angle: ${angle + 180}deg;
                --y: ${y}px;
                --delay: ${i * 0.03}s;
                --hue: ${i * 6 + 180};
              `}
              >
                <div class="base-label">{pairType}</div>
                <div class="sphere-glow" />
              </div>
              <div
                class="dna-bridge"
                style={`
                --angle: ${angle}deg;
                --y: ${y}px;
                --delay: ${i * 0.03}s;
              `}
              >
                <div class="bridge-pulse" />
              </div>
              {/* Add connection lines */}
              {i < 59 && (
                <>
                  <div
                    class="backbone-line line-1"
                    style={`--y: ${y}px; --angle: ${angle}deg;`}
                  />
                  <div
                    class="backbone-line line-2"
                    style={`--y: ${y}px; --angle: ${angle + 180}deg;`}
                  />
                </>
              )}
            </div>
          );
        })
      }

      {/* Energy field */}
      <div class="dna-energy-field"></div>

      {/* Axis core */}
      <div class="dna-axis"></div>
    </div>
  </div>
</div>

<style>
  .dna-wrapper {
    position: relative;
    width: 100%;
    min-height: 1000px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to bottom, #0a0015, #1a0933, #0f0520);
    overflow: hidden;
    padding: 60px 20px;
  }

  .dna-title {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #00ffff, #00ff88, #ff00ff);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    animation: titleShift 4s ease-in-out infinite;
  }

  .dna-subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 2rem;
    text-align: center;
  }

  .dna-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* .dna-btn styles replaced by ModernButton variant="neon" */

  .dna-btn.active {
    background: rgba(0, 255, 255, 0.2) !important;
    border-color: #00ffff !important;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.5) !important;
  }

  .dna-stats {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(0, 255, 255, 0.2);
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }

  .stat-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #00ffff;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  }

  .dna-container {
    position: relative;
    width: 650px;
    height: 750px;
    perspective: 1500px;
  }

  .dna-container:hover .dna-helix {
    animation-play-state: paused;
  }

  .dna-helix {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    animation: rotateHelix 25s linear infinite;
  }

  .base-pair {
    position: relative;
  }

  .dna-sphere {
    position: absolute;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform-style: preserve-3d;
    transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
      translateZ(0);
    animation: pulse 2.5s ease-in-out infinite;
    animation-delay: var(--delay);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .dna-sphere[data-clickable]:hover {
    transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
      translateZ(30px) scale(1.4);
    animation-play-state: paused;
  }

  .dna-sphere.selected {
    animation: selectedPulse 0.8s ease-in-out infinite;
    z-index: 100;
  }

  .strand-1 {
    background: linear-gradient(135deg, #00ffff, #0099ff);
    box-shadow:
      0 0 25px rgba(0, 255, 255, 0.7),
      inset 0 0 12px rgba(255, 255, 255, 0.4);
  }

  .strand-2 {
    background: linear-gradient(135deg, #ff00ff, #ff0099);
    box-shadow:
      0 0 25px rgba(255, 0, 255, 0.7),
      inset 0 0 12px rgba(255, 255, 255, 0.4);
  }

  .dna-sphere[data-base='A'] {
    background: linear-gradient(135deg, #00ff88, #00ffcc) !important;
  }

  .dna-sphere[data-base='T'] {
    background: linear-gradient(135deg, #ff6600, #ffaa00) !important;
  }

  .dna-sphere[data-base='G'] {
    background: linear-gradient(135deg, #8800ff, #cc00ff) !important;
  }

  .dna-sphere[data-base='C'] {
    background: linear-gradient(135deg, #ff0066, #ff0099) !important;
  }

  [data-rainbow-mode='true'] .dna-sphere {
    background: linear-gradient(
      135deg,
      hsl(var(--hue), 100%, 60%),
      hsl(calc(var(--hue) + 60), 100%, 50%)
    ) !important;
    box-shadow:
      0 0 30px hsla(var(--hue), 100%, 60%, 0.8),
      inset 0 0 15px rgba(255, 255, 255, 0.5);
  }

  .base-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
    font-weight: 800;
    color: white;
    text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
    pointer-events: none;
  }

  .sphere-glow {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: radial-gradient(
      circle at 30% 30%,
      rgba(255, 255, 255, 0.6),
      transparent 60%
    );
    pointer-events: none;
  }

  .dna-bridge {
    position: absolute;
    width: 320px;
    height: 3px;
    left: 50%;
    top: 50%;
    margin-left: -160px;
    transform-style: preserve-3d;
    transform: rotateY(var(--angle)) translateY(var(--y)) translateZ(0);
    background: linear-gradient(
      90deg,
      rgba(0, 255, 255, 0.4),
      rgba(255, 255, 255, 0.7) 50%,
      rgba(255, 0, 255, 0.4)
    );
    animation: bridgePulse 3s ease-in-out infinite;
    animation-delay: var(--delay);
  }

  .bridge-pulse {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.8),
      transparent
    );
    animation: bridgeFlow 2s linear infinite;
  }

  .backbone-line {
    position: absolute;
    width: 2px;
    height: 15px;
    left: 50%;
    top: 50%;
    background: linear-gradient(
      to bottom,
      rgba(0, 255, 255, 0.3),
      rgba(0, 255, 255, 0.1)
    );
    transform-style: preserve-3d;
  }

  .line-1 {
    transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
      translateZ(0);
  }

  .line-2 {
    transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
      translateZ(0);
  }

  .dna-energy-field {
    position: absolute;
    width: 450px;
    height: 450px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    background: radial-gradient(
      circle,
      rgba(0, 255, 255, 0.1) 0%,
      transparent 70%
    );
    animation: energyPulse 3s ease-in-out infinite;
    pointer-events: none;
  }

  .dna-axis {
    position: absolute;
    width: 6px;
    height: 100%;
    left: 50%;
    top: 0;
    transform: translateX(-50%);
    background: linear-gradient(
      to bottom,
      rgba(0, 255, 255, 0.2),
      rgba(255, 0, 255, 0.2) 50%,
      rgba(0, 255, 255, 0.2)
    );
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    pointer-events: none;
  }

  @keyframes rotateHelix {
    from {
      transform: rotateY(0deg);
    }
    to {
      transform: rotateY(360deg);
    }
  }

  @keyframes pulse {
    0%,
    100% {
      transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
        translateZ(0) scale(1);
    }
    50% {
      transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
        translateZ(0) scale(1.15);
    }
  }

  @keyframes selectedPulse {
    0%,
    100% {
      transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
        translateZ(50px) scale(1.6);
      box-shadow:
        0 0 40px rgba(255, 255, 0, 1),
        inset 0 0 20px rgba(255, 255, 255, 0.8);
    }
    50% {
      transform: rotateY(var(--angle)) translateX(160px) translateY(var(--y))
        translateZ(50px) scale(1.8);
      box-shadow:
        0 0 60px rgba(255, 255, 0, 1),
        inset 0 0 30px rgba(255, 255, 255, 1);
    }
  }

  @keyframes bridgePulse {
    0%,
    100% {
      opacity: 0.4;
    }
    50% {
      opacity: 0.9;
    }
  }

  @keyframes bridgeFlow {
    from {
      transform: translateX(-100%);
    }
    to {
      transform: translateX(100%);
    }
  }

  @keyframes energyPulse {
    0%,
    100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.3;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.1);
      opacity: 0.6;
    }
  }

  @keyframes titleShift {
    0%,
    100% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
  }

  @media (max-width: 768px) {
    .dna-container {
      width: 450px;
      height: 650px;
    }

    .dna-sphere {
      width: 28px;
      height: 28px;
    }

    .dna-bridge {
      width: 240px;
      margin-left: -120px;
    }

    .dna-title {
      font-size: 2rem;
    }

    .dna-controls {
      gap: 8px;
    }

    .dna-btn {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
  }
</style>

<script>
  const container = document.querySelector(
    '[data-dna-interactive]'
  ) as HTMLElement | null;
  const helix = document.querySelector(
    '[data-dna-rotation]'
  ) as HTMLElement | null;
  const speedButtons = document.querySelectorAll(
    '[data-speed]'
  ) as NodeListOf<HTMLElement>;
  const colorButton = document.querySelector(
    '[data-color="rainbow"]'
  ) as HTMLElement | null;
  const spheres = document.querySelectorAll(
    '[data-clickable]'
  ) as NodeListOf<HTMLElement>;
  const rotationValue = document.querySelector(
    '[data-rotation]'
  ) as HTMLElement | null;
  const selectedValue = document.querySelector(
    '[data-selected]'
  ) as HTMLElement | null;

  if (container && helix && speedButtons && colorButton && spheres) {
    let currentSpeed = 'normal';
    let rainbowMode = false;
    let rotationDegrees = 0;
    let selectedPair: number | null = null;

    // Speed control
    speedButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        speedButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const speed = btn.dataset.speed || 'normal';
        currentSpeed = speed;

        helix.style.animationDuration =
          speed === 'fast' ? '12s' : speed === 'slow' ? '40s' : '25s';
      });
    });

    // Rainbow mode toggle
    colorButton.addEventListener('click', () => {
      rainbowMode = !rainbowMode;
      colorButton.classList.toggle('active');
      container.dataset.rainbowMode = rainbowMode.toString();
    });

    // Track rotation
    let lastTime = Date.now();
    setInterval(() => {
      const duration =
        currentSpeed === 'fast' ? 12 : currentSpeed === 'slow' ? 40 : 25;
      const elapsed = (Date.now() - lastTime) / 1000;
      rotationDegrees = (rotationDegrees + (elapsed * 360) / duration) % 360;
      lastTime = Date.now();

      if (rotationValue) {
        rotationValue.textContent = `${Math.round(rotationDegrees)}°`;
      }
    }, 100);

    // Click to select base pairs
    spheres.forEach((sphere, index) => {
      sphere.addEventListener('click', e => {
        e.stopPropagation();

        // Remove previous selection
        if (selectedPair !== null) {
          const prevPair = document.querySelectorAll(
            `[data-index="${selectedPair}"] [data-clickable]`
          );
          prevPair.forEach(s => s.classList.remove('selected'));
        }

        const pairIndex = Math.floor(index / 2);

        if (selectedPair === pairIndex) {
          // Deselect if clicking same pair
          selectedPair = null;
          if (selectedValue) selectedValue.textContent = 'None';
        } else {
          // Select new pair
          selectedPair = pairIndex;
          const pairElements = document.querySelectorAll(
            `[data-index="${pairIndex}"] [data-clickable]`
          ) as NodeListOf<HTMLElement>;
          pairElements.forEach(s => s.classList.add('selected'));

          const base1 = pairElements[0]?.dataset.base || '';
          const base2 = pairElements[1]?.dataset.base || '';
          if (selectedValue)
            selectedValue.textContent = `${base1}-${base2} (Pair ${pairIndex + 1})`;
        }
      });
    });

    // Mouse tracking for perspective tilt
    container.addEventListener('mousemove', (e: MouseEvent) => {
      const rect = container.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;

      helix.style.transform = `rotateX(${y * 20}deg) rotateZ(${x * 20}deg)`;
    });

    container.addEventListener('mouseleave', () => {
      helix.style.transform = '';
    });
  }
</script>
