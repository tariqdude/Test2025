---
/**
 * Floating Islands - 3D isometric floating platforms with depth
 */
import ModernButton from './ModernButton.astro';
---

<div class="islands-wrapper">
  <h2 class="islands-title">Floating Islands</h2>
  <p class="islands-subtitle">
    Interactive 3D worlds • Click islands to select • Drag to rotate camera
  </p>

  <div class="islands-controls" role="group" aria-label="Camera view controls">
    <ModernButton
      variant="neon"
      className="island-btn active"
      data-view="isometric"
      aria-pressed="true"
      aria-label="Isometric camera view">Isometric View</ModernButton
    >
    <ModernButton
      variant="neon"
      className="island-btn"
      data-view="top"
      aria-pressed="false"
      aria-label="Top-down camera view">Top View</ModernButton
    >
    <ModernButton
      variant="neon"
      className="island-btn"
      data-view="side"
      aria-pressed="false"
      aria-label="Side camera view">Side View</ModernButton
    >
    <ModernButton
      variant="neon"
      className="island-btn"
      data-action="reset"
      aria-label="Reset camera to default position">Reset Camera</ModernButton
    >
  </div>

  <div class="islands-info">
    <div class="info-item">
      <span class="info-label">Camera Angle</span>
      <span class="info-value" data-camera-angle>60°</span>
    </div>
    <div class="info-item">
      <span class="info-label">Selected Island</span>
      <span class="info-value" data-selected-island>None</span>
    </div>
  </div>

  <div class="islands-container" data-islands-scene>
    <div class="islands-world" data-islands-world>
      <div
        class="island"
        data-island="0"
        data-clickable
        style="--width: 220px; --height: 60px; --x: -220px; --y: -180px;"
      >
        <div class="island-top"></div>
        <div class="island-side-front"></div>
        <div class="island-side-right"></div>
        <div class="island-glow"></div>
        <div class="island-decoration">
          <div class="decoration-item pyramid"></div>
          <div class="decoration-item tree" style="left: 60%; top: 40%;"></div>
          <div class="decoration-item crystal" style="left: 75%; top: 25%;">
          </div>
        </div>
        <div class="island-label">Forest Isle</div>
      </div>

      <div
        class="island"
        data-island="1"
        data-clickable
        style="--width: 280px; --height: 70px; --x: 180px; --y: -120px;"
      >
        <div class="island-top"></div>
        <div class="island-side-front"></div>
        <div class="island-side-right"></div>
        <div class="island-glow"></div>
        <div class="island-decoration">
          <div class="decoration-item pyramid"></div>
          <div class="decoration-item pyramid" style="left: 60%; top: 45%;">
          </div>
          <div class="decoration-item tower" style="left: 35%; top: 30%;"></div>
        </div>
        <div class="island-label">Sky Temple</div>
      </div>

      <div
        class="island"
        data-island="2"
        data-clickable
        style="--width: 200px; --height: 50px; --x: -120px; --y: 110px;"
      >
        <div class="island-top"></div>
        <div class="island-side-front"></div>
        <div class="island-side-right"></div>
        <div class="island-glow"></div>
        <div class="island-decoration">
          <div class="decoration-item crystal"></div>
          <div class="decoration-item tree" style="left: 50%; top: 35%;"></div>
        </div>
        <div class="island-label">Crystal Peak</div>
      </div>

      <div
        class="island"
        data-island="3"
        data-clickable
        style="--width: 250px; --height: 65px; --x: 240px; --y: 140px;"
      >
        <div class="island-top"></div>
        <div class="island-side-front"></div>
        <div class="island-side-right"></div>
        <div class="island-glow"></div>
        <div class="island-decoration">
          <div class="decoration-item pyramid"></div>
          <div class="decoration-item tower" style="left: 65%; top: 40%;"></div>
          <div class="decoration-item tree" style="left: 80%; top: 30%;"></div>
        </div>
        <div class="island-label">Mystic Ruins</div>
      </div>

      <div
        class="island"
        data-island="4"
        data-clickable
        style="--width: 190px; --height: 45px; --x: 0px; --y: -50px;"
      >
        <div class="island-top"></div>
        <div class="island-side-front"></div>
        <div class="island-side-right"></div>
        <div class="island-glow"></div>
        <div class="island-decoration">
          <div class="decoration-item tower"></div>
          <div class="decoration-item crystal" style="left: 70%; top: 35%;">
          </div>
        </div>
        <div class="island-label">Central Hub</div>
      </div>

      {/* Connecting bridges */}
      <div
        class="bridge"
        style="--x: -50px; --y: -150px; --length: 400px; --angle: 18deg;"
      >
      </div>
      <div
        class="bridge"
        style="--x: 120px; --y: -20px; --length: 180px; --angle: 85deg;"
      >
      </div>
      <div
        class="bridge"
        style="--x: -20px; --y: 30px; --length: 160px; --angle: -30deg;"
      >
      </div>
      <div
        class="bridge"
        style="--x: 180px; --y: 10px; --length: 220px; --angle: 70deg;"
      >
      </div>

      {/* Flying particles */}
      <div class="sky-particles">
        {Array.from({ length: 20 }).map(() => <div class="sky-particle" />)}
      </div>
    </div>
  </div>
</div>

<style>
  .islands-wrapper {
    content-visibility: auto;
    contain: layout paint style;
    contain-intrinsic-size: 900px;
    padding: 8rem 2rem;
    background: linear-gradient(
      180deg,
      rgba(6, 182, 212, 0.05),
      transparent,
      rgba(14, 165, 233, 0.05)
    );
    min-height: 700px;
  }

  .islands-title {
    font-size: 4rem;
    font-weight: 900;
    text-align: center;
    margin-bottom: 1.5rem;
    background: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 50%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
  }

  .islands-subtitle {
    text-align: center;
    color: rgba(203, 213, 225, 0.9);
    margin-bottom: 2rem;
    font-size: 1.25rem;
    font-weight: 300;
  }

  .islands-controls {
    display: flex;
    gap: 12px;
    margin: 0 auto 2rem;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 700px;
  }

  /* .island-btn styles replaced by ModernButton variant="neon" */

  .island-btn.active {
    background: rgba(6, 182, 212, 0.2) !important;
    border-color: #06b6d4 !important;
    box-shadow: 0 0 30px rgba(6, 182, 212, 0.5) !important;
  }

  .islands-info {
    display: flex;
    gap: 20px;
    margin: 0 auto 3rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(6, 182, 212, 0.2);
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }

  .info-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .info-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: #06b6d4;
  }

  .islands-container {
    position: relative;
    width: 100%;
    max-width: 1000px;
    height: 700px;
    margin: 0 auto;
    perspective: 2000px;
    cursor: grab;
  }

  .islands-container:active {
    cursor: grabbing;
  }

  .islands-world {
    position: relative;
    width: 100%;
    height: 100%;
    transform: rotateX(60deg) rotateZ(-45deg);
    transform-style: preserve-3d;
    transition: transform 0.3s ease-out;
  }

  .island {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(var(--x), var(--y));
    transform-style: preserve-3d;
    animation: islandFloat 6s ease-in-out infinite;
    cursor: pointer;
    transition: all 0.4s ease;
  }

  .island:hover {
    animation-play-state: paused;
    transform: translate(var(--x), var(--y)) translateZ(20px) scale(1.05);
  }

  .island.selected {
    animation: selectedFloat 2s ease-in-out infinite;
  }

  @keyframes islandFloat {
    0%,
    100% {
      transform: translate(var(--x), var(--y)) translateZ(0);
    }
    50% {
      transform: translate(var(--x), var(--y)) translateZ(30px);
    }
  }

  @keyframes selectedFloat {
    0%,
    100% {
      transform: translate(var(--x), var(--y)) translateZ(50px) scale(1.1);
      filter: drop-shadow(0 0 40px rgba(6, 182, 212, 1));
    }
    50% {
      transform: translate(var(--x), var(--y)) translateZ(70px) scale(1.15);
      filter: drop-shadow(0 0 60px rgba(6, 182, 212, 1));
    }
  }

  .island[data-island='0'] {
    animation-delay: 0s;
  }
  .island[data-island='1'] {
    animation-delay: 0.5s;
  }
  .island[data-island='2'] {
    animation-delay: 1s;
  }
  .island[data-island='3'] {
    animation-delay: 1.5s;
  }
  .island[data-island='4'] {
    animation-delay: 2s;
  }

  .island-glow {
    position: absolute;
    width: calc(var(--width) + 40px);
    height: calc(var(--width) + 40px);
    left: -20px;
    top: -20px;
    background: radial-gradient(
      circle,
      rgba(6, 182, 212, 0.3),
      transparent 70%
    );
    transform: translateZ(calc(var(--height) + 10px));
    animation: glowPulse 3s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes glowPulse {
    0%,
    100% {
      opacity: 0.3;
      transform: translateZ(calc(var(--height) + 10px)) scale(1);
    }
    50% {
      opacity: 0.6;
      transform: translateZ(calc(var(--height) + 10px)) scale(1.1);
    }
  }

  .island-label {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%) translateZ(calc(var(--height) + 5px));
    color: #06b6d4;
    font-weight: 700;
    font-size: 0.9rem;
    white-space: nowrap;
    text-shadow: 0 0 10px rgba(6, 182, 212, 0.8);
    pointer-events: none;
  }

  .island-top {
    width: var(--width);
    height: var(--width);
    background: linear-gradient(
      135deg,
      rgba(6, 182, 212, 0.9),
      rgba(14, 165, 233, 0.7)
    );
    border: 2px solid rgba(6, 182, 212, 0.8);
    transform: translateZ(var(--height));
    position: relative;
    box-shadow:
      0 0 40px rgba(6, 182, 212, 0.5),
      inset 0 0 30px rgba(6, 182, 212, 0.3);
  }

  .island-side-front {
    width: var(--width);
    height: var(--height);
    background: linear-gradient(
      180deg,
      rgba(14, 165, 233, 0.7),
      rgba(3, 105, 161, 0.9)
    );
    border: 2px solid rgba(14, 165, 233, 0.6);
    transform-origin: bottom;
    transform: rotateX(-90deg);
    position: absolute;
    bottom: 0;
  }

  .island-side-right {
    width: var(--width);
    height: var(--height);
    background: linear-gradient(
      180deg,
      rgba(8, 145, 178, 0.7),
      rgba(7, 89, 133, 0.9)
    );
    border: 2px solid rgba(8, 145, 178, 0.6);
    transform-origin: right;
    transform: rotateY(90deg);
    position: absolute;
    right: 0;
  }

  .island-decoration {
    position: absolute;
    width: 100%;
    height: 100%;
    transform: translateZ(var(--height));
    pointer-events: none;
  }

  .decoration-item {
    position: absolute;
    left: 30%;
    top: 35%;
  }

  .decoration-item.pyramid {
    width: 25px;
    height: 35px;
    background: linear-gradient(
      180deg,
      rgba(139, 92, 246, 0.9),
      rgba(124, 58, 237, 0.7)
    );
    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
    animation: decorationGlow 2s ease-in-out infinite;
  }

  .decoration-item.tree {
    width: 20px;
    height: 30px;
    background: linear-gradient(
      180deg,
      rgba(16, 185, 129, 0.9),
      rgba(5, 150, 105, 0.8)
    );
    clip-path: polygon(
      50% 0%,
      20% 40%,
      30% 40%,
      0% 100%,
      100% 100%,
      70% 40%,
      80% 40%
    );
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
    animation: decorationGlow 2.5s ease-in-out infinite;
  }

  .decoration-item.crystal {
    width: 18px;
    height: 28px;
    background: linear-gradient(
      180deg,
      rgba(236, 72, 153, 0.9),
      rgba(219, 39, 119, 0.8)
    );
    clip-path: polygon(50% 0%, 100% 40%, 75% 100%, 25% 100%, 0% 40%);
    box-shadow: 0 0 25px rgba(236, 72, 153, 0.9);
    animation: crystalShine 1.5s ease-in-out infinite;
  }

  .decoration-item.tower {
    width: 15px;
    height: 40px;
    background: linear-gradient(
      180deg,
      rgba(251, 146, 60, 0.9),
      rgba(249, 115, 22, 0.8)
    );
    clip-path: polygon(30% 0%, 70% 0%, 80% 20%, 80% 100%, 20% 100%, 20% 20%);
    box-shadow: 0 0 20px rgba(251, 146, 60, 0.7);
    animation: decorationGlow 3s ease-in-out infinite;
  }

  @keyframes decorationGlow {
    0%,
    100% {
      filter: brightness(1);
    }
    50% {
      filter: brightness(1.5);
    }
  }

  @keyframes crystalShine {
    0%,
    100% {
      filter: brightness(1) hue-rotate(0deg);
    }
    50% {
      filter: brightness(1.8) hue-rotate(30deg);
    }
  }

  .bridge {
    position: absolute;
    left: 50%;
    top: 50%;
    width: var(--length);
    height: 8px;
    background: linear-gradient(
      90deg,
      rgba(6, 182, 212, 0.6),
      rgba(139, 92, 246, 0.8),
      rgba(6, 182, 212, 0.6)
    );
    border: 1px solid rgba(6, 182, 212, 0.8);
    transform: translate(var(--x), var(--y)) rotateZ(var(--angle))
      translateZ(40px);
    transform-style: preserve-3d;
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
  }

  .sky-particles {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .sky-particle {
    position: absolute;
    width: 3px;
    height: 3px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent);
    border-radius: 50%;
    left: calc(var(--random-x, 50) * 1%);
    top: calc(var(--random-y, 50) * 1%);
    animation: particleDrift 8s ease-in-out infinite;
    animation-delay: calc(var(--random-delay, 0) * 1s);
  }

  .sky-particle:nth-child(1) {
    --random-x: 10;
    --random-y: 20;
    --random-delay: 0;
  }
  .sky-particle:nth-child(2) {
    --random-x: 30;
    --random-y: 40;
    --random-delay: 0.5;
  }
  .sky-particle:nth-child(3) {
    --random-x: 50;
    --random-y: 15;
    --random-delay: 1;
  }
  .sky-particle:nth-child(4) {
    --random-x: 70;
    --random-y: 35;
    --random-delay: 1.5;
  }
  .sky-particle:nth-child(5) {
    --random-x: 20;
    --random-y: 60;
    --random-delay: 2;
  }
  .sky-particle:nth-child(6) {
    --random-x: 80;
    --random-y: 25;
    --random-delay: 2.5;
  }
  .sky-particle:nth-child(7) {
    --random-x: 40;
    --random-y: 70;
    --random-delay: 3;
  }
  .sky-particle:nth-child(8) {
    --random-x: 90;
    --random-y: 50;
    --random-delay: 3.5;
  }
  .sky-particle:nth-child(9) {
    --random-x: 15;
    --random-y: 80;
    --random-delay: 4;
  }
  .sky-particle:nth-child(10) {
    --random-x: 60;
    --random-y: 10;
    --random-delay: 4.5;
  }
  .sky-particle:nth-child(11) {
    --random-x: 35;
    --random-y: 45;
    --random-delay: 0.3;
  }
  .sky-particle:nth-child(12) {
    --random-x: 75;
    --random-y: 65;
    --random-delay: 0.8;
  }
  .sky-particle:nth-child(13) {
    --random-x: 25;
    --random-y: 30;
    --random-delay: 1.3;
  }
  .sky-particle:nth-child(14) {
    --random-x: 85;
    --random-y: 75;
    --random-delay: 1.8;
  }
  .sky-particle:nth-child(15) {
    --random-x: 45;
    --random-y: 20;
    --random-delay: 2.3;
  }
  .sky-particle:nth-child(16) {
    --random-x: 65;
    --random-y: 55;
    --random-delay: 2.8;
  }
  .sky-particle:nth-child(17) {
    --random-x: 5;
    --random-y: 50;
    --random-delay: 3.3;
  }
  .sky-particle:nth-child(18) {
    --random-x: 95;
    --random-y: 40;
    --random-delay: 3.8;
  }
  .sky-particle:nth-child(19) {
    --random-x: 55;
    --random-y: 85;
    --random-delay: 4.3;
  }
  .sky-particle:nth-child(20) {
    --random-x: 12;
    --random-y: 12;
    --random-delay: 4.8;
  }

  @keyframes particleDrift {
    0%,
    100% {
      transform: translate(0, 0) translateZ(0);
      opacity: 0.3;
    }
    50% {
      transform: translate(30px, -30px) translateZ(50px);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    .islands-title {
      font-size: 2.5rem;
    }

    .islands-world {
      transform: rotateX(60deg) rotateZ(-45deg) scale(0.7);
    }

    .islands-controls {
      gap: 8px;
    }

    .island-btn {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .islands-world,
    .islands-world::before,
    .islands-world::after,
    .island,
    .island::before,
    .island::after,
    .island-top,
    .island-side-front,
    .island-side-right,
    .island-glow,
    .decoration-item,
    .island-label,
    .sky,
    .sky-particle {
      animation: none !important;
      transition: none !important;
    }
    .islands-world {
      transform: rotateX(60deg) rotateZ(-45deg);
    }
  }
</style>

<script>
  const prefersReducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
  );

  const scene = document.querySelector(
    '[data-islands-scene]'
  ) as HTMLElement | null;
  const world = document.querySelector(
    '[data-islands-world]'
  ) as HTMLElement | null;
  const islands = document.querySelectorAll(
    '[data-clickable]'
  ) as NodeListOf<HTMLElement>;
  const viewButtons = document.querySelectorAll(
    '[data-view]'
  ) as NodeListOf<HTMLElement>;
  const resetButton = document.querySelector(
    '[data-action="reset"]'
  ) as HTMLElement | null;
  const cameraAngle = document.querySelector(
    '[data-camera-angle]'
  ) as HTMLElement | null;
  const selectedIslandDisplay = document.querySelector(
    '[data-selected-island]'
  ) as HTMLElement | null;

  if (scene && world && islands && !prefersReducedMotion.matches) {
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let rotationY = -45;
    let rotationX = 60;
    let selectedIsland: number | null = null;

    const islandNames = [
      'Forest Isle',
      'Sky Temple',
      'Crystal Peak',
      'Mystic Ruins',
      'Central Hub',
    ];

    const updateWorldTransform = () => {
      if (world) {
        world.style.transform = `rotateX(${rotationX}deg) rotateZ(${rotationY}deg)`;
        if (cameraAngle) {
          cameraAngle.textContent = `${Math.round(rotationX)}°, ${Math.round(rotationY)}°`;
        }
      }
    };

    // View presets
    viewButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        viewButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const view = btn.dataset.view;
        if (view === 'isometric') {
          rotationX = 60;
          rotationY = -45;
        } else if (view === 'top') {
          rotationX = 0;
          rotationY = 0;
        } else if (view === 'side') {
          rotationX = 45;
          rotationY = -90;
        }
        updateWorldTransform();
      });
    });

    // Reset camera
    if (resetButton) {
      resetButton.addEventListener('click', () => {
        rotationX = 60;
        rotationY = -45;
        updateWorldTransform();

        viewButtons.forEach(b => b.classList.remove('active'));
        const isoBtn = document.querySelector('[data-view="isometric"]');
        if (isoBtn) isoBtn.classList.add('active');
      });
    }

    // Drag to rotate
    scene.addEventListener('mousedown', (e: MouseEvent) => {
      if (!(e.target as HTMLElement).closest('[data-clickable]')) {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
      }
    });

    document.addEventListener('mousemove', (e: MouseEvent) => {
      if (isDragging) {
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        rotationY += deltaX * 0.3;
        rotationX -= deltaY * 0.3;

        rotationX = Math.max(-90, Math.min(90, rotationX));

        updateWorldTransform();

        startX = e.clientX;
        startY = e.clientY;
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Island selection
    islands.forEach((island, index) => {
      island.addEventListener('click', e => {
        e.stopPropagation();

        if (selectedIsland === index) {
          // Deselect
          island.classList.remove('selected');
          selectedIsland = null;
          if (selectedIslandDisplay) selectedIslandDisplay.textContent = 'None';
        } else {
          // Remove previous selection
          if (selectedIsland !== null) {
            islands[selectedIsland].classList.remove('selected');
          }

          // Select new island
          selectedIsland = index;
          island.classList.add('selected');
          if (selectedIslandDisplay) {
            selectedIslandDisplay.textContent =
              islandNames[index] || `Island ${index + 1}`;
          }
        }
      });
    });
  }
</script>
