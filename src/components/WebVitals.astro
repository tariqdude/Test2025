---
/**
 * Web Vitals Performance Monitor
 * Tracks and reports Core Web Vitals metrics
 */
---

<script>
  import { onCLS, onFCP, onLCP, onTTFB, onINP } from 'web-vitals';

  function sendToAnalytics(metric: any) {
    const body = JSON.stringify(metric);

    // Send to analytics endpoint (customize this)
    if (navigator.sendBeacon) {
      navigator.sendBeacon('/api/analytics', body);
    } else {
      fetch('/api/analytics', {
        body,
        method: 'POST',
        keepalive: true,
      }).catch(console.error);
    }

    // Log to console in development
    if (import.meta.env.DEV) {
      console.log('[Web Vitals]', metric.name, metric.value, metric);
    }
  }

  // Track all Core Web Vitals
  onCLS(sendToAnalytics);
  onFCP(sendToAnalytics);
  onLCP(sendToAnalytics);
  onTTFB(sendToAnalytics);
  onINP(sendToAnalytics); // INP replaced FID in web-vitals v3+

  // Performance observer for additional metrics
  if ('PerformanceObserver' in window) {
    // Long Tasks
    try {
      const longTaskObserver = new PerformanceObserver(list => {
        for (const entry of list.getEntries()) {
          if (entry.duration > 50) {
            console.warn('[Performance] Long task detected:', {
              duration: entry.duration,
              startTime: entry.startTime,
            });
          }
        }
      });
      longTaskObserver.observe({ entryTypes: ['longtask'] });
    } catch (e) {
      // Long tasks not supported
    }

    // Layout shifts
    try {
      const layoutShiftObserver = new PerformanceObserver(list => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput && (entry as any).value > 0.1) {
            console.warn('[Performance] Large layout shift:', entry);
          }
        }
      });
      layoutShiftObserver.observe({ entryTypes: ['layout-shift'] });
    } catch (e) {
      // Layout shift observer not supported
    }
  }

  // Monitor resource loading
  window.addEventListener('load', () => {
    if (performance && performance.getEntriesByType) {
      const resources = performance.getEntriesByType('resource');
      const largeResources = resources.filter(
        (r: any) => r.transferSize > 500000
      );

      if (largeResources.length > 0 && import.meta.env.DEV) {
        console.warn('[Performance] Large resources detected:', largeResources);
      }
    }
  });

  // Track navigation timing
  window.addEventListener('load', () => {
    setTimeout(() => {
      const perfData = performance.getEntriesByType('navigation')[0] as any;
      if (perfData) {
        const metrics = {
          dns: perfData.domainLookupEnd - perfData.domainLookupStart,
          tcp: perfData.connectEnd - perfData.connectStart,
          ttfb: perfData.responseStart - perfData.requestStart,
          download: perfData.responseEnd - perfData.responseStart,
          domProcessing: perfData.domComplete - perfData.domInteractive,
          total: perfData.loadEventEnd - perfData.fetchStart,
        };

        if (import.meta.env.DEV) {
          console.log('[Performance] Navigation timing:', metrics);
        }
      }
    }, 0);
  });
</script>
