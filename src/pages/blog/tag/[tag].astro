---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import MarketingLayout from '../../../layouts/MarketingLayout.astro';
import FormattedDate from '../../../components/FormattedDate.astro';
import Card from '../../../components/ui/Card.astro';
import ModernButton from '../../../components/ui/ModernButton.astro';
import Grid from '../../../components/ui/Grid.astro';
import Animate from '../../../components/ui/Animate.astro';
import Search from '../../../components/ui/Search.astro';
import TagCloud from '../../../components/ui/TagCloud.astro';
import { SITE_TITLE } from '../../../consts';
import { withBasePath } from '../../../utils/helpers';

export async function getStaticPaths() {
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );
  const tags = [...new Set(posts.flatMap(post => post.data.tags || []))];

  return tags.map(tag => ({
    params: { tag },
    props: {
      posts: posts.filter(post => post.data.tags?.includes(tag)),
      tag,
    },
  }));
}

const { posts, tag } = Astro.props;
---

<MarketingLayout
  title={`${tag} - ${SITE_TITLE}`}
  description={`Posts tagged with ${tag}`}
>
  <main
    class="relative mx-auto max-w-6xl px-4 pb-24 pt-28 text-slate-100 sm:px-6 lg:px-8"
  >
    <div
      class="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(76,29,149,0.18),_transparent_60%)]"
    >
    </div>

    <div class="space-y-16">
      <!-- Blog Header -->
      <Animate animation="fade-in" duration="slow">
        <div
          class="glass-panel relative mx-auto max-w-3xl border border-white/10 bg-white/5 p-12 text-center shadow-2xl"
        >
          <div
            class="mb-4 text-indigo-400 font-mono text-sm uppercase tracking-widest"
          >
            Tag Filter
          </div>
          <h1 class="text-4xl font-bold text-white sm:text-5xl capitalize">
            {tag}
          </h1>
          <p class="mt-4 text-lg text-slate-300">
            {posts.length} article{posts.length === 1 ? '' : 's'} found
          </p>
          <div class="mt-8">
            <TagCloud activeTag={tag} className="justify-center" />
          </div>
        </div>
      </Animate>

      <!-- Search Bar -->
      <Animate animation="fade-in" duration="slow">
        <div class="mx-auto max-w-2xl">
          <Search placeholder="Search blog posts..." maxResults={5} />
        </div>
      </Animate>

      <!-- Blog Posts Grid -->
      <Grid
        cols={3}
        gap="lg"
        responsive={{ sm: 1, md: 2, lg: 3 }}
        className="text-slate-100"
      >
        {
          posts.map((post, index) => {
            const delayMap = ['none', 'sm', 'md'] as const;
            const delay = index < 3 ? delayMap[index] : 'none';

            return (
              <Animate animation="slide-up" delay={delay} trigger="scroll">
                <Card
                  variant="glass"
                  className="h-full border-white/10 bg-white/5 text-left shadow-lg shadow-blue-500/10"
                  hover
                >
                  {post.data.heroImage && (
                    <div class="group relative mb-4 aspect-video overflow-hidden rounded-lg">
                      <Image
                        src={post.data.heroImage}
                        alt={post.data.title}
                        class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                        width={400}
                        height={225}
                      />
                      <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/70 via-slate-900/0 to-transparent opacity-90" />
                    </div>
                  )}

                  <div class="p-6">
                    <div class="mb-2 text-xs font-semibold uppercase tracking-[0.35em] text-indigo-300/80">
                      <FormattedDate date={post.data.pubDate} />
                    </div>

                    <h2 class="mb-3 text-xl font-semibold text-white line-clamp-2">
                      {post.data.title}
                    </h2>

                    {post.data.description && (
                      <p class="mb-4 text-sm text-slate-300/90 line-clamp-3">
                        {post.data.description}
                      </p>
                    )}

                    <ModernButton
                      variant="outline"
                      size="sm"
                      href={withBasePath(`blog/${post.id}/`)}
                      className="w-full border-white/20 text-slate-100 hover:border-white/40 hover:bg-white/10 hover:text-white"
                    >
                      Read Article
                    </ModernButton>
                  </div>
                </Card>
              </Animate>
            );
          })
        }
      </Grid>

      {
        posts.length === 0 && (
          <div class="glass-panel mx-auto max-w-xl border border-white/10 bg-white/5 p-10 text-center text-slate-300">
            <p>No posts found for this tag.</p>
          </div>
        )
      }

      <div class="flex justify-center pt-8">
        <ModernButton
          variant="secondary"
          href={withBasePath('blog/')}
          leftIcon="â†"
        >
          Back to All Posts
        </ModernButton>
      </div>
    </div>
  </main>
</MarketingLayout>
