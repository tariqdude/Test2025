---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import MarketingLayout from '../../layouts/MarketingLayout.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Card from '../../components/ui/Card.astro';
import ModernButton from '../../components/ui/ModernButton.astro';
import Grid from '../../components/ui/Grid.astro';
import Animate from '../../components/ui/Animate.astro';
import Search from '../../components/ui/Search.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { withBasePath } from '../../utils/helpers';
import type { Page, GetStaticPathsOptions } from 'astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  page: Page<CollectionEntry<'blog'>>;
}

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );
  return paginate(posts, { pageSize: 6 });
}

const { page } = Astro.props;
---

<MarketingLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
  <main
    class="relative mx-auto max-w-6xl px-4 pb-24 pt-28 text-slate-100 sm:px-6 lg:px-8"
  >
    <div
      class="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(76,29,149,0.18),_transparent_60%)]"
    >
    </div>

    <div class="space-y-16">
      <!-- Blog Header -->
      <Animate animation="fade-in" duration="slow">
        <div
          class="glass-panel relative mx-auto max-w-3xl border border-white/10 bg-white/5 p-12 text-center shadow-2xl"
        >
          <h1 class="text-4xl font-bold text-white sm:text-5xl">Our Blog</h1>
          <p class="mt-4 text-lg text-slate-300">
            Insights, tutorials, and updates from the team keeping static ops
            sharp.
          </p>
        </div>
      </Animate>

      <!-- Search Bar -->
      <Animate animation="fade-in" duration="slow">
        <div class="mx-auto max-w-2xl">
          <Search placeholder="Search blog posts..." maxResults={5} />
        </div>
      </Animate>

      <!-- Blog Posts Grid -->
      <Grid
        cols={3}
        gap="lg"
        responsive={{ sm: 1, md: 2, lg: 3 }}
        className="text-slate-100"
      >
        {
          page.data.map((post, index) => {
            const delayMap = ['none', 'sm', 'md'] as const;
            const delay = index < 3 ? delayMap[index] : 'none';

            return (
              <Animate animation="slide-up" delay={delay} trigger="scroll">
                <Card
                  variant="glass"
                  className="h-full border-white/10 bg-white/5 text-left shadow-lg shadow-blue-500/10"
                  hover
                >
                  {post.data.heroImage && (
                    <div class="group relative mb-4 aspect-video overflow-hidden rounded-lg">
                      <Image
                        src={post.data.heroImage}
                        alt={post.data.title}
                        class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
                        width={400}
                        height={225}
                      />
                      <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/70 via-slate-900/0 to-transparent opacity-90" />
                    </div>
                  )}

                  <div class="p-6">
                    <div class="mb-2 text-xs font-semibold uppercase tracking-[0.35em] text-indigo-300/80">
                      <FormattedDate date={post.data.pubDate} />
                    </div>

                    <h2 class="mb-3 text-xl font-semibold text-white line-clamp-2">
                      {post.data.title}
                    </h2>

                    {post.data.description && (
                      <p class="mb-4 text-sm text-slate-300/90 line-clamp-3">
                        {post.data.description}
                      </p>
                    )}

                    <ModernButton
                      variant="outline"
                      size="sm"
                      href={withBasePath(`blog/${post.id}/`)}
                      className="w-full border-white/20 text-slate-100 hover:border-white/40 hover:bg-white/10 hover:text-white"
                    >
                      Read Article
                    </ModernButton>
                  </div>
                </Card>
              </Animate>
            );
          })
        }
      </Grid>

      {
        page.data.length === 0 && (
          <div class="glass-panel mx-auto max-w-xl border border-white/10 bg-white/5 p-10 text-center text-slate-300">
            <div class="mb-6 text-slate-400">
              <svg
                class="mx-auto h-16 w-16"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                />
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-white">No entries yet</h3>
            <p class="mt-2 text-sm text-slate-400">
              The publishing queue is warming up—check back soon for new intel.
            </p>
          </div>
        )
      }

      <!-- Pagination -->
      <div class="flex justify-center gap-4 pt-8">
        {
          page.url.prev && (
            <ModernButton variant="secondary" href={page.url.prev} leftIcon="←">
              Previous
            </ModernButton>
          )
        }
        {
          page.url.next && (
            <ModernButton
              variant="secondary"
              href={page.url.next}
              rightIcon="→"
            >
              Next
            </ModernButton>
          )
        }
      </div>
    </div>
  </main>
</MarketingLayout>
